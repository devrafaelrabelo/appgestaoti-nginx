server {
    listen 80;
    server_name appgestaotibp-devcontainer.local;

    # Logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # Frontend Next.js
    location / {
        proxy_pass http://frontend_devcontainer:3002;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Backend Spring Boot (com CORS habilitado)
    location /api/ {
        # Headers CORS para todas as respostas
        add_header Access-Control-Allow-Origin "http://appgestaotibp-devcontainer.local:8088" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Auth-Status" always;

        # Trata pré-flight (OPTIONS)
        if ($request_method = OPTIONS) {
            return 204;
        }

        # Proxy para o backend (sem duplicar /api)
        proxy_pass http://backend_devcontainer:8080/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /userhub/ {
        proxy_pass http://manageraccount_devcontainer:8000;
    }

    location /selenium/ {
        proxy_pass http://automation-selenium_devcontainer:5000;
    }

    location /selenium-hub/ {
        proxy_pass http://selenium-hub_devcontainer:4444;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
  
    location /wpp-api/ {
        # Segurança básica
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";

        # CORS
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

        if ($request_method = OPTIONS) {
            return 204;
        }

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://wppconnect-server:21465/;
    }

    location /monitor/ {
        proxy_pass http://health-monitor_dev:8000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # CORS opcional (caso acesse via frontend JS)
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    location = /health {
        return 200 'NGINX OK';
        add_header Content-Type text/plain;
    }

    location = /nginx_status {
        stub_status;
        allow 127.0.0.1;           # localhost do próprio container nginx
        allow 172.17.0.0/16;       # rede Docker bridge padrão
        allow 172.18.0.0/16;       # (opcional) outra rede Docker personalizada, se usar
        deny all;
        access_log off;
        add_header Content-Type text/plain;       
    }
}

# server {
#   listen 8080;
  
#   location / {

#     add_header X-Frame-Options "SAMEORIGIN";
#     add_header X-XSS-Protection "1; mode=block";
#     add_header X-Content-Type-Options "nosniff";

#     charset utf-8;
    
#     proxy_http_version 1.1;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection $http_connection;
#     proxy_set_header Access-Control-Allow-Origin *;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_pass http://wppconnect-front:3000;
#   }
# }
